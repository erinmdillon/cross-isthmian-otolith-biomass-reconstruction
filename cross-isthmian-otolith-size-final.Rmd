---
title: "cross-isthmian-otolith-size-final"
author: "Erin Dillon"
date: "2025-06-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script cleans, aligns, and analyzes the otolith size data to reconstruct per-capita fish biomass.

# Libraries
```{r warning=F}
library(rfishbase)
library(tidyverse)
library(ggplot2)
library(patchwork)
library(janitor)
library(plotrix)
library(hydroGOF)
library(knitr)
library(kableExtra)
library(psych)
```


# Otolith size - fish size relationships

## Fish families in sediment assemblages
- total possible family list in the sediment assemblages based on raw counts and classifications; note that some get filtered out later on due to site filtering or if measurements couldn't be obtained

- this list is used to constrain data collection and size-size modeling to families that make sense given our reef sediment assemblages
```{r}

#all fish families found in Pacific and Caribbean sediment assemblages
all_families <- c("Acanthuridae","Albulidae","Apogonidae","Atherinidae","Atherinopsidae","Batrachoididae","Belonidae","Blenniidae","Bothidae","Bregmacerotidae","Bythitidae","Carangidae","Carapidae","Chaetodontidae","Clupeidae","Congridae","Engraulidae","Gerreidae","Gobiidae","Haemulidae","Hemiramphidae","Labridae","Labrisomidae","Lutjanidae","Mugilidae","Mullidae","Muraenidae","Ophidiidae","Opistognathidae","Paralichthyidae","Peristediidae","Pomacanthidae","Pomacentridae","Priacanthidae","Scaridae","Sciaenidae","Scorpaenidae","Serranidae","Sparidae","Synodontidae")

```

## Reference collection

### In-house reference collection

load data
```{r}

#in-house reference collection
oto_size_raw <- read.csv("oto_reference_collection_main.csv",header=T)

#additional Lutjanus samples from the Atlantic
extra_lutjanus_raw <- read.csv("oto_reference_collection_lutjanus.csv",header=T)

```

clean and combine datasets
```{r}

#in-house reference collection, format to be consistent with other data inputs
oto_size <- oto_size_raw %>%
  #use left oto measurement when available, otherwise right
  mutate(otolith_length_mm = ifelse(
    is.na(left.otolith.length.mm)==F, left.otolith.length.mm,right.otolith.length.mm)) %>%
  filter(!Complete_name %in% c("Pomadasys panamensis", "Microspathodon bairdii")) %>% #unusual
  select(Collection_Number,Ocean,Region,Locality,Order,Family,genus,species,Complete_name,total_length_cm,standard_length_cm,otolith_length_mm)


#Lutjanus samples to supplement reference collection
extra_lutjanus <- extra_lutjanus_raw %>% 
  rename(Region=Site,
         otolith_length_mm=Otolith_length_mm) %>% #these are all right otoliths
  mutate(total_length_cm = total_length_mm/10,
         standard_length_cm = standard_length_mm/10) %>% 
  select(Collection_Number,Ocean,Region,Locality,Order,Family,genus,species,Complete_name,total_length_cm,standard_length_cm,otolith_length_mm) 


#merge datasets and clean header names
oto_ref_col <- rbind(oto_size,extra_lutjanus) %>% 
  filter(!is.na(total_length_cm) & !is.na(otolith_length_mm)) %>% #just keep paired fish-oto measurements
  clean_names()

```

check available sample sizes
```{r}

#family-level sample sizes for which both otolith and fish size data are available
oto_ref_col_n <- oto_ref_col %>% 
  group_by(family) %>%
  filter(is.na(otolith_length_mm)==F & is.na(total_length_cm)==F) %>% 
  tally()
oto_ref_col_n


#add column to clean dataset with family-level sample sizes, for later filtering
oto_ref_col <- oto_ref_col %>% 
  left_join(oto_ref_col_n,by="family")

```


### AFORO database

load data, source: http://aforo.cmima.csic.es/
downloaded April 2025
```{r}

aforo_raw <- read.csv("aforo_morphometrics.csv",header=T)

```

clean data
```{r}

#clean and format for consistency with our reference collection data
aforo_clean <- aforo_raw %>% 
  filter(length_type == "TL") %>% #constrain to total length for consistency
  filter(!is.na(fish_length) & !is.na(otolith_length)) %>% #just keep rows with paired fish and oto length data
  mutate(total_length_cm=fish_length/10) %>% #fish length is measured in mm, converting to cm
  rename(otolith_length_mm=otolith_length,
         otolith_width_mm=otolith_width) %>% #oto length & width measured in mm (right)
  mutate(source = "AFORO",.before=family) #adding a source column


#sample sizes
aforo_n <- aforo_clean %>% 
  group_by(family) %>%
  tally()
aforo_n


#add column with family-level sample sizes
aforo_clean <- aforo_clean %>% 
  left_join(aforo_n,by="family")

```



### Combined size-size dataset
```{r}

#clean ref col data to be consistent format
oto_ref_col_to_merge <- oto_ref_col %>% 
  mutate(source = "Reference Collection",.before=collection_number) %>% #add source column
  select(-c(order,standard_length_cm)) #remove unneeded columns


#clean aforo data to match
aforo_to_merge <- aforo_clean %>% 
  rename(collection_number=inst_code) %>% 
  mutate(ocean = NA, #this info was not extracted
         region = NA,
         locality = NA,
         genus = NA,
         species = NA,
         complete_name = NA) %>% 
  select(c("source","collection_number","ocean","region","locality","family","genus","species","complete_name","total_length_cm","otolith_length_mm","n")) #keep the same columns, same order


#confirm that headers match up
names(oto_ref_col_to_merge)
names(aforo_to_merge)


#merge datasets
size_size_merged <- rbind(oto_ref_col_to_merge,aforo_to_merge)
head(size_size_merged)


#filter to just include families found in the sediment samples
size_size_merged_corefam <- size_size_merged %>% 
   filter(family %in% all_families)

```


check available sample sizes in full size-size dataset
```{r}

#sampling n for all families, regardless of whether they're found in the sediments
table(size_size_merged$family)
n_distinct(size_size_merged$family)


#sampling n for families found in the sediment samples
table(size_size_merged_corefam$source) #n per source
table(size_size_merged_corefam$family) #n per family
length(size_size_merged_corefam$family) #total n
n_distinct(size_size_merged_corefam$family) #n families


size_size_merged_corefam %>% 
  group_by(family,source) %>% 
  tally()


#sample size comparison
sample_n <- aforo_n %>% 
  full_join(oto_ref_col_n,by="family") %>% 
  rename(aforo_n=n.x,
         ref_col_n=n.y) %>% 
  mutate(aforo_n = replace_na(aforo_n, 0), #replace NA = 0
         ref_col_n = replace_na(ref_col_n, 0)) %>% 
  mutate(total_n = aforo_n+ref_col_n)
sample_n


#add total_n to df for filtering
size_size_merged_corefam <- size_size_merged_corefam %>% 
  left_join(sample_n[,c(1,4)],by="family") %>% 
  mutate(family_label = paste0(family," (n=",total_n,")"))



```

Note: families in sed assemblages with <15 data points for size-size relationships not used to build family-specific power models: Albulidae (0), Atherinopsidae (0), Bregmacerotidae (1), Hemiramphidae (5), Labrisomidae (0), Opistognathidae (1), Paralichthyidae (9), Priacanthidae (11)


## Plot size-size relationships

### figure S3
```{r fig.width=4}

#altogether
size_size_merged_corefam %>%
  filter(total_n>14) %>% #remove families with n<15
ggplot(aes(y=total_length_cm,x=otolith_length_mm))+
  geom_smooth(aes(color=family_label,fill=family_label),method=lm,se=T,linewidth=0.8,alpha=0.3)+ #family-level model
  geom_smooth(method=lm,color="black",se=T,linewidth=2)+ #overall model
  labs(x="Otolith length (mm)",y="Fish total length (cm)",color="Family",fill="Family")+
  theme_bw()+
   scale_y_continuous(trans='log2')+ 
   scale_x_continuous(trans='log2')+
  theme(aspect.ratio=1)

```

### figure S4
```{r fig.height=4, fig.width=3.5}

#by family and source
size_size_merged_corefam %>%
  filter(total_n>14) %>% #remove families with n<15
ggplot(aes(y=total_length_cm,x=otolith_length_mm))+
  geom_point(aes(fill=family,shape=source),size = 2, alpha = 0.3, stroke = 0.1,color="black")+
  geom_smooth(aes(color=family,fill=family),method=lm,se=T,linewidth=0.8)+ #family-level model
  scale_shape_manual(values=c(21,24))+
  labs(x="Otolith length (mm)",y="Fish total length (cm)",color="Family",fill="Family",shape="Source")+
  theme_bw()+
   scale_y_continuous(trans='log2')+ 
   scale_x_continuous(trans='log2')+
  theme(aspect.ratio=1)+
  guides(fill="none",color="none")+
  theme(legend.position = "bottom")+
  theme(aspect.ratio=1)+
  facet_wrap(~family,ncol=6)

```


## Power models

### Otolith length - fish TL
family list
```{r}

#families to exclude (n<15 data points)
to_exclude <- c("Albulidae","Atherinopsidae","Bregmacerotidae","Hemiramphidae","Labrisomidae","Malacanthidae","Opistognathidae","Paralichthyidae","Priacanthidae")

  
#to build family-level models
family_list <- all_families[!(all_families %in% to_exclude)] #all families in sed record - families with low n

#how many families
length(family_list)


```
aggregate power model - all families with sufficient data combined
```{r}

#excluding families with low n
size_size_merged_corefam2 <- size_size_merged_corefam %>% 
  filter(family %in% family_list)

#which families represented
table(size_size_merged_corefam2$family)
n_distinct(size_size_merged_corefam2$family)


#build nls power model
power_fit_all <- nls(total_length_cm~a*otolith_length_mm^b,data=size_size_merged_corefam2, start = list(a=1, b=1))

#view summary and coefficients
summary(power_fit_all)
a_est <- coef(power_fit_all)["a"]
b_est <- coef(power_fit_all)["b"]


#NSE to assess model fit (pseudo r square values)
nse_length_overall <- NSE(sim = fitted(power_fit_all), obs = power_fit_all$m$lhs())

```

family-level power models
```{r}

#initialize empty list & matrix to store model outputs
allometric_models <- list()
model_coeff <- matrix(NA,nrow=length(family_list),ncol=3)
model_coeff <- as.data.frame(model_coeff)
names(model_coeff) <- c("family","a","b")

#row counter to populate the matrix
counter <- 1

#filter data to include only the specified families with sufficient data
size_size_filtered <- size_size_merged %>% 
   filter(family %in% family_list)
table(size_size_filtered$family) #which families represented, consistent with overall NLS model above
n_distinct(size_size_filtered$family)

#loop through each family to fit a model for each
for (fam in family_list) {
  data_family <- subset(size_size_filtered, family == fam)
  
  #fit an allometric model using nls and store in the allometric_models list
  allometric_model <- nls(total_length_cm~a*otolith_length_mm^b, data = data_family, start = list(a = 1, b = 1))
  allometric_models[[fam]] <- allometric_model
  
  #print the summary of the allometric model for each family
  cat("Allometric model for family:", fam, "\n")
  print(summary(allometric_model))
  cat("\n\n")  #add space between model summaries
  
  #store coefficients in the data frame
  model_coeff[counter,1] <- fam
  model_coeff[counter,2] <- coef(allometric_model)["a"]
  model_coeff[counter,3] <- coef(allometric_model)["b"]
  counter <- counter + 1 #update row counter
}


#check outputs
allometric_models
model_coeff

```
NSE for family-level models to assess fit
```{r}


#initialize an empty vector to store NSE values
nse_values <- numeric(length(allometric_models))
nse_family_length <- numeric(length(allometric_models))

#calculate and store NSE for each model
for (i in seq_along(allometric_models)) {
  family <- names(allometric_models)[i]
  model <- allometric_models[[i]]
  
  #get observed and predicted values
  observed <- model$m$lhs() # observed values
  predicted <- fitted(model) # predicted values
  
  #calculate NSE and print
  nse_values[i] <- NSE(sim = predicted, obs = observed) 
  nse_family_length[i] <- family
  cat("Pseudo R-squared (NSE) for family:", family, "is", nse_values[i], "\n")
}

nse_values

#most >0.7 (good model performance)
#use aggregate model for families with <0.5 NSE values: Acanthuridae, Carangidae, Congridae, Clupeidae, Synodontidae

#compile
nse_length <- as.data.frame(cbind(nse_family_length,nse_values)) %>% 
  rename(family = nse_family_length,
         nse_length = nse_values) %>% 
  mutate(nse_length=as.numeric(nse_length)) %>% 
  mutate(nse_length=round(nse_length,3))

```

### Otolith width - fish TL

Aforo only given data availability
```{r}

aforo_width_corefam <- aforo_clean %>% 
  filter(family %in% family_list) #same list as for lengths, just families with sufficient data

```

build power model
```{r}

#nls power model
power_fit_all_width <- nls(total_length_cm~a*otolith_width_mm^b,data=aforo_width_corefam, start = list(a=1, b=1))

#model summary and coefficients
summary(power_fit_all_width)
a_est_width <- coef(power_fit_all_width)["a"]
b_est_width <- coef(power_fit_all_width)["b"]


#NSE
nse_width_overall <- NSE(sim = fitted(power_fit_all_width), obs = power_fit_all_width$m$lhs())

```

family-level power models
```{r}

#initialize empty list & matrix to store model outputs
allometric_models_width <- list()
model_coeff_width <- matrix(NA,nrow=length(family_list),ncol=3)
model_coeff_width <- as.data.frame(model_coeff_width)
names(model_coeff_width) <- c("family","a","b")

#row counter to populate the matrix
counter <- 1


#loop through each family to fit a model for each
for (fam in family_list) {
  data_family <- subset(aforo_width_corefam, family == fam)
  
  #fit an allometric model using nls and store in the allometric_models list
  allometric_model_width <- nls(total_length_cm~a*otolith_width_mm^b, data = data_family, start = list(a = 1, b = 1))
  allometric_models_width[[fam]] <- allometric_model_width
  
  #print the summary of the allometric model for each family
  cat("Allometric model for family:", fam, "\n")
  print(summary(allometric_model_width))
  cat("\n\n")  #add space between model summaries
  
  #store coefficients in the data frame
  model_coeff_width[counter,1] <- fam
  model_coeff_width[counter,2] <- coef(allometric_model_width)["a"]
  model_coeff_width[counter,3] <- coef(allometric_model_width)["b"]
  counter <- counter + 1 #update row counter
}


#check outputs
allometric_models_width
model_coeff_width

```

NSE for family-level models to assess fit
```{r}

#initialize an empty vector to store NSE values
nse_values_width <- numeric(length(allometric_models_width))
nse_family_width <- numeric(length(allometric_models_width))

#calculate and store NSE for each model
for (i in seq_along(allometric_models_width)) {
  family <- names(allometric_models_width)[i]
  model <- allometric_models_width[[i]]
  
  #get observed and predicted values
  observed <- model$m$lhs() # Observed values
  predicted <- fitted(model) # Predicted values
  
  #calculate NSE and print
  nse_values_width[i] <- NSE(sim = predicted, obs = observed) 
  nse_family_width[i] <- family
  cat("Pseudo R-squared (NSE) for family:", family, "is", nse_values_width[i], "\n")
}


#NSE lower than for oto lengths, as expected
#families with <0.5 NSE values: Acanthuridae, Batrachoididae, Carangidae, Chaetodontidae, Clupeidae, Congridae, Gerreidae, Haemulidae, Peristediidae, Pomacentridae, Scaridae, Synodontidae


#compile
nse_width <- as.data.frame(cbind(nse_family_width,nse_values_width)) %>% 
  rename(family = nse_family_width,
         nse_width = nse_values_width) %>% 
  mutate(nse_width=as.numeric(nse_width)) %>% 
  mutate(nse_width=round(nse_width,3))

```


### table S2
compiled coefficients and NSE values
```{r}

#compile values
length_coefficient <- model_coeff %>% 
  rename(length_a = a,
         length_b = b)


width_coeffient <- model_coeff_width %>% 
  rename(width_a = a,
         width_b = b)


model_coefficients <- length_coefficient %>% 
  full_join(width_coeffient,by="family") %>% 
  left_join(nse_length,by="family") %>% 
  left_join(nse_width,by="family")

model_coefficients

#add overall model
overall_coefficients <- data.frame(family="Aggregate Model", length_a=a_est,length_b=b_est,width_a=a_est_width,width_b=b_est_width,nse_length=nse_length_overall,nse_width=nse_width_overall)

#combine
model_coefficients <- rbind(model_coefficients,overall_coefficients)

model_coefficients %>% 
  rename(`Family`=family,
         `a (length)`=length_a,
         `b (length)`=length_b,
         `a (width)`=width_a,
         `b (width)`=width_b,
         `NSE (length)`=nse_length,
         `NSE (width)`=nse_width) %>% 
kable(digits = 2,row.names = FALSE)%>%
  kable_classic(full_width = FALSE) %>%
  kable_styling(font_size=12) %>%
  row_spec(0, bold = TRUE) %>% 
  row_spec(0:nrow(model_coefficients), extra_css = "padding:2px;")

```


# Reconstruct fish length in sediment assemblages

## Pacific
load data
```{r}

#load raw data
oto_pac_size_raw <- read.csv("pacific_oto_meas.csv",header=T)


#cleaning
oto_pac_size_clean <- oto_pac_size_raw %>%
  mutate(family = case_when( #correcting spelling
    family=="Gobidae" ~ "Gobiidae",
    family=="Gonidae" ~ "Gobiidae",
    family=="Blennidae" ~ "Blenniidae",
    family=='Bythididae' ~'Bythitidae',
    family=='Cangridae' ~'Congridae',
    TRUE ~ family)) %>% 
  filter(!family %in% c("fragmento de otolito","sin identificar")) #removing unidentified otoliths


#families represented
table(oto_pac_size_clean$family)

```

apply power models to predict fish length from otolith size
```{r}

#remove families with low NSE values (see above) = using aggregate model for these
low_NSE <- c("Acanthuridae", "Carangidae", "Congridae","Clupeidae", "Synodontidae")

low_NSE_width <- c("Acanthuridae", "Batrachoididae", "Carangidae", "Chaetodontidae", "Clupeidae", "Congridae", "Gerreidae", "Haemulidae", "Peristediidae", "Pomacentridae", "Scaridae", "Synodontidae")



#function to predict fish length from the corresponding allometric model - lengths
predict_allometric <- function(fam, oto) {
  model <- allometric_models[[fam]]
  new_data=data.frame(otolith_length_mm=oto)
  if (!is.null(model) & !fam %in% low_NSE) { #now reverting low_NSE fams to overall model
    pred <- predict(model,newdata=new_data)
    coefs <- coef(model)
    pred_manual <- coefs['a'] * (oto ^ coefs['b']) #confirming that this gives the same value
    return(pred)
  } else {
    overall_pred <- predict(power_fit_all,newdata=new_data)
    return(overall_pred) #return prediction from overall model if family-lvl model doesn't exist
  }
}



#equivalent function to predict fish length from the corresponding allometric model using otolith widths
predict_allometric_width <- function(fam, oto) {
  model <- allometric_models_width[[fam]]
  new_data=data.frame(otolith_width_mm=oto)
  if (!is.null(model) & !fam %in% low_NSE_width) { #now reverting low_NSE fams to overall model
    pred <- predict(model,newdata=new_data)
    coefs <- coef(model)
    pred_manual <- coefs['a'] * (oto ^ coefs['b']) #confirming that this gives the same value
    return(pred)
  } else {
    overall_pred <- predict(power_fit_all_width,newdata=new_data)
    return(overall_pred) #return prediction from overall model if family-lvl model doesn't exist
  }
}



#add predictions to the dataset - length and width
oto_pac_size_length <- oto_pac_size_clean %>%
  mutate(oto_length_mm=length_um/1000, #model predicts from mm
       oto_width_mm=width_um/1000) %>%
  #create variable for the predicted fish total lengths
mutate(fish_length_cm = case_when(
  !is.na(oto_length_mm) ~ mapply(predict_allometric,
                                  fam = .data$family,
                                  oto = .data$oto_length_mm),
  is.na(oto_length_mm) ~mapply(predict_allometric_width,
                                  fam = .data$family,
                                  oto = .data$oto_width_mm)))




#filtering out unreasonably small fish for families that shouldn't be that small (suggesting incorrect taxonomy)
oto_pac_size_length <- oto_pac_size_length %>% 
  filter(fish_length_cm>0.5)

```

add functional group information
```{r}

#load trait table
fish_traits_pacific <- read.csv("pacific_fish_functions.csv",header=T)

#trait info
fish_traits_matrix_pacific <- fish_traits_pacific[,c(2,3,5,6,7,11,12)] %>% 
  clean_names() %>% 
  rename(harvested=harvested_combined)


#sample the pomacentridae given their multiple feeding groups

#pull out just the Pomacentridae trait data
Pom <- fish_traits_matrix_pacific %>%
  filter(family == "Pomacentridae") %>%
  #probabilies from Reef Life Survey - TEP reefs in Panama
  mutate(prob = case_when(
    feeding == "omnivore_carnivore" ~ 0.03, #abudefduf, microspathodon
    feeding == "herbivore" ~ 0.13, #stegastes
    feeding == "planktivore" ~ 0.84)) #chromis

#Assign each row in the orig dataframe to a trait based on given probabilities
set.seed(46)
oto_pac_size_length_Pom <- oto_pac_size_length %>% 
  filter(basin=="Pacific" & family == "Pomacentridae") %>%
  mutate(feeding = sample(Pom$feeding, size = n(), replace = TRUE, prob = Pom$prob)) %>% 
  mutate(habit = Pom$habit[1],
         reef_associated = Pom$reef_associated[1],
         cryptobenthic = Pom$cryptobenthic[1],
         harvested = Pom$harvested[1],
         prey_of_harvested_fishes = Pom$prey_of_harvested_fishes[1])


#add functional groupings to the otolith dataset (except Pomacentridae)
oto_pac_size_length_noPom <- oto_pac_size_length %>% 
  filter(basin=="Pacific") %>% 
  filter(!family %in% c("Pomacentridae")) %>% 
  left_join(fish_traits_matrix_pacific,by="family")

#check names
names(oto_pac_size_length_Pom);names(oto_pac_size_length_noPom)

#recombine
oto_pac_size_length <- rbind(oto_pac_size_length_noPom,oto_pac_size_length_Pom)

```


## Caribbean
load data, note that size data were collected in stages (r1, r2, r3) so require some cleaning and harmonizing
```{r}

#read in raw data, data collection round 1
oto_carib_size_r1_raw <- read.csv("carib_oto_meas_r1.csv",header=T)


#cleaning
oto_carib_size_r1_clean <- oto_carib_size_r1_raw %>% 
  clean_names() %>% 
  filter(region=="Bocas") %>% #constrain to Bocas del Toro
  #remove sites that we're not using in the analysis (non-reef or anomalous depositional environments)
  filter(!locality %in% c('Sweet Bocas Trench 6','Airport Point','Playa Estrella','SW Bocas Island')) %>%
  filter(!str_starts(sample, "AT14-11")) %>% #poor preservation
  mutate(type_age = case_when(
    type_age == "Pleistocene?" ~ "Holocene", #AT13-7-8 is holocene; but this gets removed later (sand, no reef)
    TRUE ~ type_age))

```

```{r}

#data collection round 2
oto_carib_size_r2_raw <- read.csv("carib_oto_meas_r2.csv",header=T)

#cleaning
oto_carib_r2_to_merge <- oto_carib_size_r2_raw %>%
  clean_names() %>% 
  filter(region=="Bocas") %>% #constrain to bocas
  #remove sites that we're not using in the analysis, same as above
  filter(!locality %in% c('Sweet Bocas Trench 6','Airport Point','Playa Estrella','SW Bocas Island')) %>%
  filter(!str_starts(sample, "AT14-11")) %>% #poor preservation
  #keep same headers for merging
  select(names(oto_carib_size_r1_clean))

#to track which measurements were added in the combined df
samples_merged  <- oto_carib_size_r1_clean %>% 
  mutate(source="orig_df") %>% 
  select(family,sample,oto_length_mm,source)

#combine and just keep the non-duplicate rows
oto_carib_size_clean_combined <- bind_rows(oto_carib_size_r1_clean,oto_carib_r2_to_merge) %>% 
  distinct() %>% #remove duplicates
  left_join(samples_merged, by=c("family","sample","oto_length_mm")) %>%  #to track what was added
  mutate(oto_width_mm = minor_axis_length/100) %>% #make variable for otolith width
  select(-c(major_axis_length,minor_axis_length)) #remove a couple of extraneous columns


```

```{r}

#data collection round 3
oto_carib_size_r3_raw <- read.csv("carib_oto_meas_r3.csv",header=T)


#cleaning and formatting

#make 'N/A' values read as actual NAs (currently they are being read as character values)
oto_carib_size_r3_raw$length_um <- oto_carib_size_r3_raw$length_um %>%
  na_if("N/A") %>%      
  as.numeric()

oto_carib_size_r3_raw$width_um <- oto_carib_size_r3_raw$width_um %>%
  na_if("N/A") %>%      
  as.numeric()


#get new df into same format as existing Caribbean df
oto_carib_clean_r3 <- oto_carib_size_r3_raw %>%
  mutate(region=case_when(
    region=="Bocas del Toro" ~ "Bocas"),
    source="new_2025",
    oto_length_mm=length_um/1000,
    oto_width_mm=width_um/1000,
    type_age=case_when(
      age_group == "modern_bulk" ~ "Sub Recent",
      age_group == "Holocene_bulk" ~ "Holocene")) %>% #to make columns consistent with other df
  rename(locality=site_name,
         oto_length_um=length_um,
         oto_width_um=width_um) %>% 
  mutate(family = case_when( #correcting spelling
    family=="Egraulidae" ~ "Engraulidae",
    TRUE ~ family)) %>% 
  filter(!locality %in% c('Sweet Bocas Trench 6','Airport Point','Playa Estrella','SW Bocas Island')) %>%
  filter(!str_starts(sample, "AT14-11")) %>%
  filter(!ocean=="CODE WITHOUT OTOLITHS") %>% #row of NAs
  select(names(oto_carib_size_clean_combined))
  
  
```

combine datasets and check for consistency
```{r}

#merge datasets
oto_carib_size_clean_combined2 <- rbind(oto_carib_size_clean_combined,oto_carib_clean_r3) %>% 
  mutate(family = case_when( #correcting one more spelling error
    family=="Scianidae" ~ "Sciaenidae",
    TRUE ~ family))




#check consistency across some of key groupings (localities, age groups, families)
table(oto_carib_size_clean_combined2$locality)
table(oto_carib_size_clean_combined2$type_age)
table(oto_carib_size_clean_combined2$family)


#remove a couple families with problematic IDs which were changed during later taxonomic verification
oto_carib_size_clean_combined2 <- oto_carib_size_clean_combined2 %>% 
  filter(!family %in% c("Muraenidae","Carangidae","Sphyraenidae","Cynoglossidae","Macrouridae","Mugilidae","Sciaenidae"))
```

clean Caribbean data (renamed and ready for analysis)
```{r}

oto_carib_size_clean <- oto_carib_size_clean_combined2

```


apply power models to predict fish length from otolith size, using the functions created above
```{r}

oto_carib_size_length <- oto_carib_size_clean %>%
  #create variable for the predicted fish total lengths
mutate(fish_length_cm = case_when(
  !is.na(oto_length_mm) ~ mapply(predict_allometric,
                                  fam = .data$family,
                                  oto = .data$oto_length_mm),
  is.na(oto_length_mm) ~mapply(predict_allometric_width, #predicts from width if length is not available
                                  fam = .data$family,
                                  oto = .data$oto_width_mm))) %>%
mutate(age_group=case_when(
  type_age=='Sub Recent' ~ 'modern',
  type_age=='Holocene' ~ 'pre_exp'
))

```


add functional group information
```{r}
#load trait table for caribbean
fish_traits_carib <- read.csv("carib_fish_functions.csv",header=T)

#relevant trait info
fish_traits_matrix_carib <- fish_traits_carib[,c(2,3,5,6,8,9,12)] %>% 
  clean_names()%>% 
  rename(harvested=harvested_in_sitio_drago)

#sample the pomacentridae given their multiple feeding groups

#pull out just the Pomacentridae trait data
Pom_carib <- fish_traits_matrix_carib %>%
  filter(family == "Pomacentridae") %>%
  #probabilies from Reef Life Survey - Caribbean reefs in Panama (note diff from TEP!)
  mutate(prob = case_when(
    feeding == "omnivore_carnivore" ~ 0.04, #abudefduf, microspathodon
    feeding == "herbivore" ~ 0.94, #stegastes
    feeding == "planktivore" ~ 0.02)) #azurina

#Assign each row in the orig dataframe to a trait based on given probabilities
set.seed(46)
oto_carib_size_length_Pom <- oto_carib_size_length %>% 
  filter(family == "Pomacentridae") %>%
  mutate(feeding = sample(Pom_carib$feeding, size = n(), replace = TRUE, prob = Pom_carib$prob)) %>% 
  mutate(habit = Pom_carib$habit[1],
         reef_associated = Pom_carib$reef_associated[1],
         cryptobenthic = Pom_carib$cryptobenthic[1],
         harvested = Pom_carib$harvested[1],
         prey_of_harvested_fishes = Pom_carib$prey_of_harvested_fishes[1])


#add functional groupings to the otolith dataset (except Pomacentridae)
oto_carib_size_length_noPom <- oto_carib_size_length %>% 
  filter(!family %in% c("Pomacentridae")) %>% 
  left_join(fish_traits_matrix_carib,by="family")

#check names
names(oto_carib_size_length_Pom);names(oto_carib_size_length_noPom)

#recombine
oto_carib_size_length <- rbind(oto_carib_size_length_noPom,oto_carib_size_length_Pom)

```


## Pacific & Caribbean combined
```{r}

names(oto_pac_size_length)
names(oto_carib_size_length)

#make formatting consistent
oto_size_pac_to_merge <- oto_pac_size_length %>% 
  select(basin,region,site_name,sample,unique,age_group,family,oto_length_mm,oto_width_mm,fish_length_cm,feeding,habit,cryptobenthic,prey_of_harvested_fishes, harvested, reef_associated)

oto_size_carib_to_merge <- oto_carib_size_length %>% 
  mutate(basin="Caribbean") %>% 
  rename(site_name=locality) %>% 
  rename(unique=sample) %>% 
  separate(col = unique,
           into = c("first_part", "second_part", "third_part","fourth_part"),
           sep = "-",
           remove = FALSE) %>% # Keep the original column
  mutate(sample = paste0(first_part, "-", second_part)) %>%
  select(-first_part, -second_part, -third_part,-fourth_part) %>% 
  select(basin,region,site_name,sample,unique,age_group,family,oto_length_mm,oto_width_mm,fish_length_cm,feeding,habit,cryptobenthic,prey_of_harvested_fishes, harvested, reef_associated)

#merge
oto_size_length_merged <- rbind(oto_size_pac_to_merge,oto_size_carib_to_merge)


#remove any other broken otoliths for which size could not be reconstructed
oto_size_length_merged <- subset(oto_size_length_merged, !is.na(fish_length_cm))

```

check data included
```{r}

table(oto_size_length_merged$family)
table(oto_size_length_merged$site_name)


#caribbean sites/age
oto_size_length_merged %>% 
  filter(basin=="Caribbean") %>% 
  distinct(age_group, site_name) %>%
  group_by(age_group) %>%               
  summarise(sites = list(site_name)) %>% 
  deframe()


#pacific samples/age
oto_size_length_merged %>% 
  filter(basin=="Pacific") %>% 
  distinct(age_group, site_name, unique) %>%
  group_by(age_group) %>%               
  summarise(sites = list(unique)) %>% 
  deframe()

```

### figure S8
raw otolith sizes and fish lengths, plotted by basin and time point
```{r fig.width=3.5, fig.height=3.5}

#calculate means
length_means_plot <- oto_size_length_merged %>%
  mutate(age_group=factor(age_group, levels = c("pre_exp", "modern"),labels=c("Mid-Holocene","Modern"))) %>%
  group_by(age_group,basin) %>% 
  summarize(oto_length_mean = mean(oto_length_mm,na.rm=T),
            fish_length_mean = mean(fish_length_cm,na.rm=T)) %>% 
  mutate(y_pos = case_when(
    basin == "Caribbean" ~ -0.155,
    basin == "Pacific" ~ -0.065
  ))
length_means_plot



#otolith length
S8a <- oto_size_length_merged %>%
  mutate(age_group=factor(age_group, levels = c("pre_exp", "modern"),labels=c("Mid-Holocene","Modern"))) %>%
  ggplot(aes(x=oto_length_mm))+
  geom_density(aes(color=basin, fill=basin),alpha=0.3,linewidth=0.8,adjust=1.5)+
  geom_boxplot(
    aes(y = -0.11, fill = basin),
    position = position_dodge(width = 0.18),
    color="gray5",
    width = 0.1,
    alpha = 0.8,
    outlier.shape = NA
  ) +
  geom_point(data=length_means_plot,
  aes(x=oto_length_mean, y = y_pos, color = basin),
  fill="gray5",
  shape = 23,
  size = 2.6,
  position = position_dodge(width = 0.18)
)+
  labs(y="Density",x="Otolith length (mm)",fill="Region",color="Region",title="A  Otolith length") +
  scale_fill_manual(values=c("darkgoldenrod2","deepskyblue3"))+
  scale_color_manual(values=c("darkgoldenrod2","deepskyblue3"))+
  theme_bw()+
  scale_x_continuous(trans='log2')+ #to deal with long tail
  theme(aspect.ratio=1)+
  theme(legend.position = "none")+
  facet_grid(~age_group)


#reconstructed fish length
S8b <- oto_size_length_merged %>%
  mutate(age_group=factor(age_group, levels = c("pre_exp", "modern"),labels=c("Mid-Holocene","Modern"))) %>%
  ggplot(aes(x=fish_length_cm))+
  geom_density(aes(color=basin, fill=basin),alpha=0.3,linewidth=0.8,adjust=1.5)+
  geom_boxplot(
    aes(y = -0.11, fill = basin),
    position = position_dodge(width = 0.18),
    color="gray5",
    width = 0.1,
    alpha = 0.8,
    outlier.shape = NA
  ) +
  geom_point(data=length_means_plot,
  aes(x=fish_length_mean, y = y_pos, color = basin),
  fill="gray5",
  shape = 23,
  size = 2.6,
  position = position_dodge(width = 0.18)
)+
  labs(y="Density",x="Fish total length (cm)",fill="Region",color="Region",title="B  Fish total length (reconstructed)") +
  scale_fill_manual(values=c("darkgoldenrod2","deepskyblue3"))+
  scale_color_manual(values=c("darkgoldenrod2","deepskyblue3"))+
  theme_bw()+
  scale_x_continuous(trans='log2')+ #to deal with long tail
  theme(aspect.ratio=1)+
  theme(legend.position = "bottom")+
  facet_grid(~age_group)


S8 <- S8a/S8b
S8


```

### table S1
```{r}

#combine ecological data
table_S1 <- fish_traits_matrix_pacific %>% 
  rename(Pacific_feeding=feeding) %>% 
  full_join (fish_traits_matrix_carib[,c(1,2,5)],by="family") %>% 
  rename(Caribbean_feeding=feeding) %>% 
  filter(family %in% all_families) %>% 
  select(family,Caribbean_feeding,Pacific_feeding,cryptobenthic) %>% 
  mutate() %>% 
  rename(Family=family,
         Cryptobenthic=cryptobenthic)

#condense Pomacentridae  
table_S1$Caribbean_feeding[table_S1$Family == "Pomacentridae"] <- "herbivore*"  
table_S1$Pacific_feeding[table_S1$Family == "Pomacentridae"] <- "mixed*" 

table_S1 <- table_S1 %>% 
  distinct()

#update omni_carn label
table_S1[table_S1 == "omnivore_carnivore"] <- "generalised carnivore"


#print
table_S1 %>% 
  rename(`Trophic group (Caribbean)`=Caribbean_feeding,
         `Trophic group (Pacific)`=Pacific_feeding) %>% 
  select(-Cryptobenthic) %>% 
kable()%>% 
  kable_classic(full_width = FALSE)%>%
  kable_styling(font_size=12) %>%
  row_spec(0, bold = TRUE) %>% 
  row_spec(0:nrow(table_S1), extra_css = "padding:2px;")


```


# Reconstruct fish biomass in sediment assemblages

## Length-weight relationships

compile species list for Caribbean and Pacific coasts of Panama
Caribbean: https://biogeodb.stri.si.edu/caribbean/en/pages
Pacific: https://biogeodb.stri.si.edu/sftep/en/pages
```{r}

#fish species lists for Caribbean and TEP

#TEP = Panamic Province, downloaded 5/28/25
panamic_species <- read.csv("species_list_pacific_panamic.csv",header=T)

panamic_species <- panamic_species %>% 
  mutate(basin="Pacific")


#Caribbean = SW Caribbean Ecoregion, downloaded 6/11/25
caribbean_species <- read.csv("species_list_caribbean_swecoregion.csv",header=T)

caribbean_species <- caribbean_species %>% 
  mutate(basin="Caribbean")


#combine
species_list <- rbind(panamic_species,caribbean_species)

```


Add higher level taxonomic info from FishBase, using `rfishbase` package
```{r}

#load taxonomic data from fishbase (takes a bit of time to load)
taxa_data <- load_taxa()

#check data format
head(taxa_data)
#write.csv(taxa_data,"taxa_data_fishbase_2025.csv") #saving copy of downloaded data

#now add family info for each species in our list
species_list <- species_list %>% 
  rename(Species=species_name) %>% 
  left_join(taxa_data[,c(2,3,5)],by="Species") %>% 
  select(Family, Genus, everything())

table(species_list$Family)

```


filter list to families present in sediment assemblages
```{r}

species_list_filtered <- species_list %>% 
  filter(Family %in% c(all_families,"Dorosomatidae")) #adding Dorosomatidae since taxonomy has been updated from Clupeidae

table(species_list_filtered$Family) #all fams represented, note Dorosomatidae==Clupeidae here (taxonomy revised)

```

Compile length-weight scaling coefficients from FishBase, from power model W=aL^b (units: cm-g)
```{r}

#add scaling at the family level, pull from rfishbase using length_weight() function, run June 2025
lwr_data <- length_weight(species_list_filtered$Species)


#filter for valid non-NA coefficients and TL (total length) values to be consistent with fish length predictions
lwr_data <- subset(lwr_data, !is.na(a) & !is.na(b))
lwr_data <- subset(lwr_data, Type == "TL") #just keeping coeff for total length measurements


#check available data
length(unique(lwr_data$Species)) #382 species
length(species_list_filtered$Species) #1026 species total, so only a subset have available data


#merge dfs to keep both demographic info with taxonomic metadata
lwr_data <- lwr_data %>% 
  left_join(species_list_filtered[,c(1:3)],by="Species") %>% #add metadata
  select(Family,Species,Type,Locality,a,b) %>% #keep just relevant data
  distinct() #keep unique rows

#write.csv(lwr_data,"lwr_fishbase_2025.csv") #saving copy of downloaded data
table(lwr_data$Family) #all but one family (Bythitidae) have available data


#Calculate family-level mean coefficients (a,b) 
family_lwr <- lwr_data %>%
  group_by(Family) %>%
  summarize(
    n_species = n_distinct(Species),
    n_estimates = n(),
    mean_a = mean(a, na.rm = TRUE),
    mean_b = mean(b, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  rename(family=Family) %>%  #for merging
  mutate(family = ifelse(family == "Dorosomatidae", "Clupeidae", family))  #revert taxonomy so it lines up with the otolith classifications


#add data for Bythitidae, see KULBICKI et al 2005, "A general approach to length-weight relationships  for New Caledonian lagoon fishes" https://horizon.documentation.ird.fr/exl-doc/pleins_textes/divers16-09/010067956.pdf

bythid <- tibble(
  family = "Bythitidae",
  n_species = 1, #Dinematichthys spp.
  n_estimates = 55,
  mean_a = 0.0072,
  mean_b = 3.155)

  
#combine with other family-level data  
family_lwr <- rbind(family_lwr, bythid)

```

### table S3
```{r}
#output table of coefficients
family_lwr %>% 
  arrange(family) %>% 
  rename(`Family`=family,
         `N species`=n_species,
         `N estimates`=n_estimates,
         `a (mean)`=mean_a,
         `b (mean)`=mean_b) %>% 
  kable(digits = 2,row.names = FALSE)%>%
  kable_classic(full_width = FALSE) %>%
  kable_styling(font_size=12) %>%
  row_spec(0, bold = TRUE) %>% 
  row_spec(0:nrow(family_lwr), extra_css = "padding:1px;") %>% 
  column_spec(2, width = "75px") %>% 
  column_spec(3, width = "75px") %>% 
  column_spec(4, width = "75px") %>% 
  column_spec(5, width = "75px")

#number of families
length(family_lwr$family)
  
```

## Calculate fish biomass metrics

pull sample metadata
```{r}

#load oto count data
oto_pan_raw <- read.csv("oto_abund.csv",header=T,na.strings=".")


#select relevant metadata
oto_sample_metadata <- oto_pan_raw %>% 
  select(unique,group_name) %>% 
  distinct()


#manually adding groups for a couple of additional samples
new_groups <- tibble(
  unique = c('AT13-2-3','AT12-2-1B','AFH12-1-1-1-F','AFH12-1-2-3-R','AT13-10-5'),
  group_name = c('AT13-2_1','AT12-2_1','AFH12-1_1','AFH12-1_2','AT13-10_9'))
  
oto_sample_metadata <- rbind(oto_sample_metadata,new_groups)



#calculate sediment weights of pooled samples
pooled_weights_biomass <- oto_pan_clean %>% 
  group_by(basin,group_name) %>% 
  summarize(sed_weight_500_kg_group = sum(sed_weight_500_kg,na.rm=T),
            sed_weight_group = sum(sed_weight_whole_sample_kg,na.rm=T),
            oto_check = sum(total_oto_count,na.rm=T))


#sample weight comparison
pooled_weights_biomass %>% 
  group_by(basin) %>% 
  summarize(mean_sample_weight= mean(sed_weight_group,na.rm=T),
            mean500_weight = mean(sed_weight_500_kg_group,na.rm=T))

oto_pan %>%
  group_by(basin) %>% 
  summarize(mean_sample_weight= mean(sed_weight_whole_sample_kg,na.rm=T),
            mean500_weight = mean(sed_weight_500_kg,na.rm=T))

```

calculate mean per-capita fish biomass
```{r}

#use mean length-weight coefficients to predict biomass for each otolith
oto_biomass_merged_pre <- oto_size_length_merged %>%
  left_join(family_lwr, by = "family") %>%  #add coefficients for each family
  left_join(oto_sample_metadata,by="unique") %>%  #add sample metadata
  mutate(fish_weight_g = mean_a * fish_length_cm^mean_b) %>%   #estimate fish wet weight for each otolith
  mutate(site_name = case_when(
    str_starts(site_name, "Sweet Bocas Trench") ~ "Sweet Bocas Trench",
    TRUE ~ site_name
  ))
  

#calculate per capita biomass and production  
oto_biomass_merged <- oto_biomass_merged_pre %>% 
  group_by(basin,region,site_name,age_group,group_name) %>% #calculate per sample group
  summarize(biomass_summed = sum(fish_weight_g,na.rm=T), #calculate total biomass per sample
            n_otoliths = sum(!is.na(fish_weight_g)), #total oto count with data, i.e. number of "individuals"
            per_capita_biomass = biomass_summed/n_otoliths, #mean per-capita biomass
            
            #per-capita biomass of different ecological groups
            pisc_pcb = sum(fish_weight_g[feeding == 'piscivore'],na.rm=T)/sum(feeding == 'piscivore',na.rm=T),
            carn_pcb = sum(fish_weight_g[feeding == 'omnivore_carnivore'],na.rm=T)/sum(feeding == 'omnivore_carnivore',na.rm=T),
            plank_pcb = sum(fish_weight_g[feeding == 'planktivore'],na.rm=T)/sum(feeding == 'planktivore',na.rm=T),
            herb_pcb = sum(fish_weight_g[feeding == 'herbivore'],na.rm=T)/sum(feeding == 'herbivore',na.rm=T),
            crypto_pcb = sum(fish_weight_g[cryptobenthic == 'Cryptobenthic'],na.rm=T)/sum(cryptobenthic == 'Cryptobenthic',na.rm=T),
            demersal_pcb = sum(fish_weight_g[habit == 'demersal'],na.rm=T)/sum(habit == 'demersal',na.rm=T),
            pelagic_pcb = sum(fish_weight_g[habit == 'pelagic'],na.rm=T)/sum(habit == 'pelagic',na.rm=T),
            reef_pcb = sum(fish_weight_g[reef_associated == 'Yes'],na.rm=T)/sum(reef_associated == 'Yes',na.rm = T),
            prey_pcb = sum(fish_weight_g[prey_of_harvested_fishes == 'Yes'],na.rm=T)/sum(prey_of_harvested_fishes == 'Yes',na.rm=T),
            harvested_pcb = sum(fish_weight_g[harvested == 'Yes'],na.rm=T)/sum(harvested == 'Yes',na.rm=T),
            
            #proportional biomass of feeding groups
            pisc_prop = sum(fish_weight_g[feeding == 'piscivore'],na.rm=T)/biomass_summed,
            carn_prop = sum(fish_weight_g[feeding == 'omnivore_carnivore'],na.rm=T)/biomass_summed,
            plank_prop = sum(fish_weight_g[feeding == 'planktivore'],na.rm=T)/biomass_summed,
            herb_prop = sum(fish_weight_g[feeding == 'herbivore'],na.rm=T)/biomass_summed) %>%
  distinct()


#add combined basin-time group for plotting
oto_biomass_merged <- oto_biomass_merged %>% 
  unite(age_group_region, c("basin","age_group"),remove=F) %>% 
  mutate(age_group_region=as.factor(age_group_region))


```

sample sizes, at level of per-capita biomass estimates
```{r}
#by basin and region
oto_biomass_merged %>%
  group_by(basin,age_group) %>% 
  tally()

#by site
oto_biomass_merged %>%
  group_by(basin,site_name) %>% 
  tally()

```

## Plotting

### figure 2
figure 2A
```{r fig.width=3}

#calculate means
biomass_means_plot <- oto_biomass_merged %>%
  mutate(age_group=factor(age_group, levels = c("pre_exp", "modern"),labels=c("Mid-Holocene","Modern"))) %>%
  group_by(age_group,basin) %>% 
  summarize(biomass_mean = mean(per_capita_biomass,na.rm=T),
            non_na_count = sum(!is.na(per_capita_biomass))) %>% 
  mutate(y_pos = case_when(
    basin == "Caribbean" ~ -0.155,
    basin == "Pacific" ~ -0.065
  ))
biomass_means_plot

#separate out raw data to get jittered boxplot
raw_biomass_means <- oto_biomass_merged %>%
  mutate(age_group=factor(age_group, levels = c("pre_exp", "modern"),labels=c("Mid-Holocene","Modern"))) %>%
  mutate(y_pos = case_when(
    basin == "Caribbean" ~ -0.155,
    basin == "Pacific" ~ -0.065
  ))


####ANNOTATIONS
#basin annotation
annotation_df <- data.frame(
  x = c(0.48,4),
  y = c(0.27,0.35),  
  label = c("Caribbean","Pacific"),
  color = c("darkgoldenrod2","deepskyblue3"),
  basin = c("Caribbean","Pacific"),
  age_group = "Mid-Holocene"  # matching facet variable
)

#sample size annotation
annotation_n <- data.frame(
  x = 0.25,
  y = c(-0.065,-0.155,-0.065,-0.155),  
  label = c("(N=34)","(N=25)","(N=9)","(N=41)"),
  basin = c("Pacific","Caribbean","Pacific","Caribbean"),
  age_group = c("Mid-Holocene","Mid-Holocene","Modern","Modern")
)



#####PLOT
fig2a <- oto_biomass_merged %>% 
  mutate(basin=factor(basin)) %>% 
  mutate(age_group=factor(age_group, levels = c("pre_exp", "modern"),labels=c("Mid-Holocene","Modern"))) %>%
  ggplot(aes(x=per_capita_biomass))+
  geom_density(aes(color=basin, fill=basin),alpha=0.3,linewidth=0.8,adjust=2)+
  geom_jitter(data=raw_biomass_means,aes(x=per_capita_biomass,y=y_pos,fill=basin,color=basin),
               size=2,
               shape=21,
                color="gray40",
               alpha=0.4,
               position = position_jitterdodge(jitter.height = 0.02, jitter.width = 0.5, dodge.width = 0.18))+
  geom_boxplot(
    aes(y = -0.11, fill = basin),
    position = position_dodge(width = 0.18),
    color="gray5",
    width = 0.1,
    alpha = 0.8,
    outlier.shape = NA
  ) +
  geom_point(data=biomass_means_plot,
  aes(x=biomass_mean, y = y_pos, color = basin),
  fill="gray5",
  shape = 23,
  size = 2.6,
  position = position_dodge(width = 0.18)
)+
  geom_text(data = annotation_df, aes(x = x, y = y, label = label,color=basin,inherit.aes = FALSE), size = 5.5,fontface = "bold")+
  #geom_text(data = annotation_n, aes(x = x, y = y, label = label), size = 2.5,fontface = "italic")+
  #annotate("text",x = 0.05, y = 0.17, label = "Caribbean", size = 5.5, hjust = 0,color="darkgoldenrod2")+
  #annotate("text",x = 5.5, y = 0.17, label = "Pacific", size = 5.5, hjust = 0,color="deepskyblue3")+
  #coord_cartesian(ylim = c(-0.18, NA)) +
  labs(y="Density",x="Mean per-capita biomass (g)",fill="Basin",color="Basin") +
  scale_fill_manual(values=c("darkgoldenrod2","deepskyblue3"))+
  scale_color_manual(values=c("darkgoldenrod2","deepskyblue3"))+
  theme_bw()+
  theme(axis.text = element_text(size=8),axis.title= element_text(size=12))+
  scale_x_continuous(trans='log2')+
  theme(legend.position = "none")+
  theme(aspect.ratio=1)+
  facet_grid(~age_group)+
  theme(strip.background = element_rect(fill = NA, color = NA),
        strip.text = element_text(size = 16))

fig2a

```


figure 2B
```{r}

#function to calculate percent difference
perc_diff <- function(val1,val2){
  ((val1-val2)/((val1+val2)/2))*100
}
```

bootstrapped percent difference across basins for each feeding group
```{r}

#calculate bootstrapped percent difference

##########################PISC
##MID-HOLOCENE
#defining the data values
df1 <-oto_biomass_merged$pisc_pcb[oto_biomass_merged$age_group=="pre_exp" & oto_biomass_merged$basin=="Pacific"]
df2 <-oto_biomass_merged$pisc_pcb[oto_biomass_merged$age_group=="pre_exp" & oto_biomass_merged$basin=="Caribbean"]

#change NAs to 0s
df1[is.na(df1)] <- 0
df2[is.na(df2)] <- 0

#bootstrapped percent differences
set.seed(123)
boot_holocene_pisc <- do.call(c,lapply(1:1000, function(boot){ #1000 iterations
  a <- sample(df1, size=1,replace = T) #pulls value from Pacific with replacement
  b <- sample(df2, size=1,replace = T) #pulls value from Caribbean with replacement
  perc_diff(a,b) #calculates percent difference between those two values
}))


boot_holocene_pisc_df <- as.data.frame(boot_holocene_pisc) %>% 
  rename(percent_diff = boot_holocene_pisc) %>% 
  add_column(age_group='pre_exp',.before="percent_diff") %>% 
add_column(feeding='pisc_pcb',.before="percent_diff")

hist(boot_holocene_pisc)
mean(boot_holocene_pisc,na.rm=T)



##MODERN
#defining the data values
df1 <-oto_biomass_merged$pisc_pcb[oto_biomass_merged$age_group=="modern" & oto_biomass_merged$basin=="Pacific"]
df2 <-oto_biomass_merged$pisc_pcb[oto_biomass_merged$age_group=="modern" & oto_biomass_merged$basin=="Caribbean"]

#change NAs to 0s
df1[is.na(df1)] <- 0
df2[is.na(df2)] <- 0

#bootstrapped percent differences
set.seed(123)
boot_modern_pisc <- do.call(c,lapply(1:1000, function(boot){ #1000 iterations
  a <- sample(df1, size=1,replace = T) #pulls value from Pacific with replacement
  b <- sample(df2, size=1,replace = T) #pulls value from Caribbean with replacement
  perc_diff(a,b) #calculates percent difference between those two values
}))


boot_modern_pisc_df <- as.data.frame(boot_modern_pisc) %>% 
  rename(percent_diff = boot_modern_pisc) %>% 
  add_column(age_group='modern',.before="percent_diff") %>% 
add_column(feeding='pisc_pcb',.before="percent_diff")

hist(boot_modern_pisc)
mean(boot_modern_pisc,na.rm=T)


##########################CARN
##MID-HOLOCENE
#defining the data values
df1 <-oto_biomass_merged$carn_pcb[oto_biomass_merged$age_group=="pre_exp" & oto_biomass_merged$basin=="Pacific"]
df2 <-oto_biomass_merged$carn_pcb[oto_biomass_merged$age_group=="pre_exp" & oto_biomass_merged$basin=="Caribbean"]

#change NAs to 0s
df1[is.na(df1)] <- 0
df2[is.na(df2)] <- 0

#bootstrapped percent differences
set.seed(123)
boot_holocene_carn <- do.call(c,lapply(1:1000, function(boot){ #1000 iterations
  a <- sample(df1, size=1,replace = T) #pulls value from Pacific with replacement
  b <- sample(df2, size=1,replace = T) #pulls value from Caribbean with replacement
  perc_diff(a,b) #calculates percent difference between those two values
}))


boot_holocene_carn_df <- as.data.frame(boot_holocene_carn) %>% 
  rename(percent_diff = boot_holocene_carn) %>% 
  add_column(age_group='pre_exp',.before="percent_diff") %>% 
add_column(feeding='carn_pcb',.before="percent_diff")

hist(boot_holocene_carn)
mean(boot_holocene_carn,na.rm=T)



##MODERN
#defining the data values
df1 <-oto_biomass_merged$carn_pcb[oto_biomass_merged$age_group=="modern" & oto_biomass_merged$basin=="Pacific"]
df2 <-oto_biomass_merged$carn_pcb[oto_biomass_merged$age_group=="modern" & oto_biomass_merged$basin=="Caribbean"]

#change NAs to 0s
df1[is.na(df1)] <- 0
df2[is.na(df2)] <- 0

#bootstrapped percent differences
set.seed(123)
boot_modern_carn <- do.call(c,lapply(1:1000, function(boot){ #1000 iterations
  a <- sample(df1, size=1,replace = T) #pulls value from Pacific with replacement
  b <- sample(df2, size=1,replace = T) #pulls value from Caribbean with replacement
  perc_diff(a,b) #calculates percent difference between those two values
}))


boot_modern_carn_df <- as.data.frame(boot_modern_carn) %>% 
  rename(percent_diff = boot_modern_carn) %>% 
  add_column(age_group='modern',.before="percent_diff") %>% 
add_column(feeding='carn_pcb',.before="percent_diff")

hist(boot_modern_carn)
mean(boot_modern_carn,na.rm=T)


##########################PLANK
##MID-HOLOCENE
#defining the data values
df1 <-oto_biomass_merged$plank_pcb[oto_biomass_merged$age_group=="pre_exp" & oto_biomass_merged$basin=="Pacific"]
df2 <-oto_biomass_merged$plank_pcb[oto_biomass_merged$age_group=="pre_exp" & oto_biomass_merged$basin=="Caribbean"]

#change NAs to 0s
df1[is.na(df1)] <- 0
df2[is.na(df2)] <- 0

#bootstrapped percent differences
set.seed(123)
boot_holocene_plank <- do.call(c,lapply(1:1000, function(boot){ #1000 iterations
  a <- sample(df1, size=1,replace = T) #pulls value from Pacific with replacement
  b <- sample(df2, size=1,replace = T) #pulls value from Caribbean with replacement
  perc_diff(a,b) #calculates percent difference between those two values
}))


boot_holocene_plank_df <- as.data.frame(boot_holocene_plank) %>% 
  rename(percent_diff = boot_holocene_plank) %>% 
  add_column(age_group='pre_exp',.before="percent_diff") %>% 
add_column(feeding='plank_pcb',.before="percent_diff")

hist(boot_holocene_plank)
mean(boot_holocene_plank,na.rm=T)



##MODERN
#defining the data values
df1 <-oto_biomass_merged$plank_pcb[oto_biomass_merged$age_group=="modern" & oto_biomass_merged$basin=="Pacific"]
df2 <-oto_biomass_merged$plank_pcb[oto_biomass_merged$age_group=="modern" & oto_biomass_merged$basin=="Caribbean"]

#change NAs to 0s
df1[is.na(df1)] <- 0
df2[is.na(df2)] <- 0

#bootstrapped percent differences
set.seed(123)
boot_modern_plank <- do.call(c,lapply(1:1000, function(boot){ #1000 iterations
  a <- sample(df1, size=1,replace = T) #pulls value from Pacific with replacement
  b <- sample(df2, size=1,replace = T) #pulls value from Caribbean with replacement
  perc_diff(a,b) #calculates percent difference between those two values
}))


boot_modern_plank_df <- as.data.frame(boot_modern_plank) %>% 
  rename(percent_diff = boot_modern_plank) %>% 
  add_column(age_group='modern',.before="percent_diff") %>% 
add_column(feeding='plank_pcb',.before="percent_diff")

hist(boot_modern_plank)
mean(boot_modern_plank,na.rm=T)


##########################HERB
##MID-HOLOCENE
#defining the data values
df1 <-oto_biomass_merged$herb_pcb[oto_biomass_merged$age_group=="pre_exp" & oto_biomass_merged$basin=="Pacific"]
df2 <-oto_biomass_merged$herb_pcb[oto_biomass_merged$age_group=="pre_exp" & oto_biomass_merged$basin=="Caribbean"]

#change NAs to 0s
df1[is.na(df1)] <- 0
df2[is.na(df2)] <- 0

#bootstrapped percent differences
set.seed(123)
boot_holocene_herb <- do.call(c,lapply(1:1000, function(boot){ #1000 iterations
  a <- sample(df1, size=1,replace = T) #pulls value from Pacific with replacement
  b <- sample(df2, size=1,replace = T) #pulls value from Caribbean with replacement
  perc_diff(a,b) #calculates percent difference between those two values
}))


boot_holocene_herb_df <- as.data.frame(boot_holocene_herb) %>% 
  rename(percent_diff = boot_holocene_herb) %>% 
  add_column(age_group='pre_exp',.before="percent_diff") %>% 
add_column(feeding='herb_pcb',.before="percent_diff")

hist(boot_holocene_herb)
mean(boot_holocene_herb,na.rm=T)



##MODERN
#defining the data values
df1 <-oto_biomass_merged$herb_pcb[oto_biomass_merged$age_group=="modern" & oto_biomass_merged$basin=="Pacific"]
df2 <-oto_biomass_merged$herb_pcb[oto_biomass_merged$age_group=="modern" & oto_biomass_merged$basin=="Caribbean"]

#change NAs to 0s
df1[is.na(df1)] <- 0
df2[is.na(df2)] <- 0

#bootstrapped percent differences
set.seed(123)
boot_modern_herb <- do.call(c,lapply(1:1000, function(boot){ #1000 iterations
  a <- sample(df1, size=1,replace = T) #pulls value from Pacific with replacement
  b <- sample(df2, size=1,replace = T) #pulls value from Caribbean with replacement
  perc_diff(a,b) #calculates percent difference between those two values
}))


boot_modern_herb_df <- as.data.frame(boot_modern_herb) %>% 
  rename(percent_diff = boot_modern_herb) %>% 
  add_column(age_group='modern',.before="percent_diff") %>% 
add_column(feeding='herb_pcb',.before="percent_diff")

hist(boot_modern_herb)
mean(boot_modern_herb,na.rm=T)

```

```{r}

#combine bootstrap results
boot_combined_oto <-rbind(boot_holocene_pisc_df,boot_modern_pisc_df,boot_holocene_carn_df,boot_modern_carn_df,boot_holocene_plank_df,boot_modern_plank_df,boot_holocene_herb_df,boot_modern_herb_df) 


#add fill colors
boot_combined_oto <- boot_combined_oto %>% 
  mutate(fill_color=case_when(
           age_group=="pre_exp" & feeding=="pisc_pcb" ~ "PAC",
           age_group=="modern" & feeding=="pisc_pcb" ~ "PAC",
           age_group=="pre_exp" & feeding=="carn_pcb" ~ "PAC",
           age_group=="modern" & feeding=="carn_pcb" ~ "PAC",
           age_group=="pre_exp" & feeding=="plank_pcb" ~ "PAC",
           age_group=="modern" & feeding=="plank_pcb" ~ "PAC",
           age_group=="pre_exp" & feeding=="herb_pcb" ~ "CARIB",
           age_group=="modern" & feeding=="herb_pcb" ~ "CARIB"))

#summary
PD_summary <- boot_combined_oto %>% 
  group_by(age_group,feeding) %>% 
  summarize(pd_mean=mean(percent_diff, na.rm=T), 
            pd_sd=sd(percent_diff, na.rm=T),
            pd_stderr=std.error(percent_diff, na.rm=T),
            pd_ci_low=quantile(percent_diff, probs = c(0.025), na.rm = TRUE),
            pd_ci_up=quantile(percent_diff, probs = c(0.975), na.rm = TRUE)) %>% 
  mutate(fill_color=case_when(
           pd_mean>0 ~ "PAC",
           pd_mean<0 ~ "CARIB")) 
PD_summary

#plot
fig2b <- PD_summary %>% 
  mutate(age_group=factor(age_group, levels = c("pre_exp", "modern"),labels=c("Mid-Holocene","Modern"))) %>% 
ggplot(aes(y = feeding, x = pd_mean)) +
  geom_col(aes(fill=fill_color),show.legend = FALSE,alpha=0.8) +
  geom_vline(xintercept = 0, linetype = 1,color='gray20') +
  geom_errorbarh(aes(xmin=pd_mean-pd_sd, xmax=pd_mean+pd_sd), height=.2,
                 position=position_dodge(.9),linetype=1,size=0.6,color="gray30")+
  scale_y_discrete(limits=c("herb_pcb","plank_pcb","carn_pcb","pisc_pcb"),labels=c("herbivores","planktivores","generalised\ncarnivores","piscivores"))+
  scale_fill_manual(values=c("darkgoldenrod2","deepskyblue3"))+
  labs(x="Bootstrapped percent difference (%)\nbetween Pacific and Caribbean Panama",y="") +
  theme_bw()+
  theme(axis.text = element_text(size=8),axis.title= element_text(size=12),axis.text.y = element_text(size=12))+
  theme(legend.text = element_text(size=10),legend.title = element_text(size=12))+
  theme(axis.text=element_text(color="black",family="sans"),axis.title= element_text(color="black",family="sans",hjust=0.5))+
  theme(aspect.ratio=0.7)+
  facet_grid(~age_group)+
  theme(strip.background = element_rect(fill = NA, color = NA),
      strip.text = element_blank())
fig2b

```

figure 2 combined
```{r fig.width=3,fig.height=3}

fig2 <- fig2a / fig2b+
  plot_layout(widths = c(1, 1))&
  plot_annotation(tag_levels = 'A')&
  theme(plot.tag = element_text(size = 16, face = "bold"),
        plot.tag.position = c(0, 1))
  
fig2

```

```{r fig.width=3,fig.height=3}

##output
ggsave("xmus_oto_fig2.pdf",plot=fig2,device="pdf",useDingbats=FALSE)

```


### figure 3
figure 3A
```{r fig.width=3.2}

#calculate means
biomass_regional_means_plot <- oto_biomass_merged %>%
  mutate(age_group=factor(age_group, levels = c("pre_exp", "modern"),labels=c("Mid-Holocene","Modern"))) %>%
  mutate(region=factor(region, levels = c("Bocas", "Gulf of Panama"),labels=c("Caribbean (Bocas del Toro)","Pacific (Gulf of Panama)"))) %>%
  group_by(region,age_group,age_group_region) %>% 
  summarize(biomass_mean = mean(per_capita_biomass,na.rm=T),
            non_na_count = sum(!is.na(per_capita_biomass))) %>% 
  mutate(y_pos = case_when(
    age_group == "Modern" ~ -0.155,
    age_group == "Mid-Holocene" ~ -0.065
  ))
biomass_regional_means_plot



#separate out raw data to get jittered boxplot
raw_biomass_regional_means <- oto_biomass_merged %>%
  mutate(age_group=factor(age_group, levels = c("pre_exp", "modern"),labels=c("Mid-Holocene","Modern"))) %>%
  mutate(region=factor(region, levels = c("Bocas", "Gulf of Panama"),labels=c("Caribbean (Bocas del Toro)","Pacific (Gulf of Panama)"))) %>%
  mutate(y_pos = case_when(
    age_group == "Modern" ~ -0.155,
    age_group == "Mid-Holocene" ~ -0.065
  ))


#sample size annotation
annotation_regional_n <- data.frame(
  x = 0.075,
  y = c(-0.0255,-0.055,-0.0255,-0.055),  
  label = c("(N=55)","(N=48)","(N=116)","(N=38)"),
  region = c("Caribbean (Bocas del Toro)","Caribbean (Bocas del Toro)","Pacific (Gulf of Panama)","Pacific (Gulf of Panama)"),
  age_group = c("Mid-Holocene","Modern","Mid-Holocene","Modern")
)


  
  

#####PLOT
fig3a <- oto_biomass_merged %>% 
  mutate(region=factor(region, levels = c("Bocas", "Gulf of Panama"),labels=c("Caribbean (Bocas del Toro)","Pacific (Gulf of Panama)"))) %>%
ggplot(aes(x=per_capita_biomass))+
  geom_density(position="identity",aes(color=region,fill=age_group_region),alpha=0.6,linewidth=0.8,adjust=2)+
  geom_jitter(data=raw_biomass_regional_means,aes(x=per_capita_biomass,y=y_pos,fill=age_group_region,color=region),
               size=2,
               shape=21,
              #color="gray40",
               alpha=0.4,
               position = position_jitterdodge(jitter.height = 0.02, jitter.width = 0.5, dodge.width = 0.18))+
  geom_boxplot(
    aes(y = -0.11, fill = age_group_region,color=region),
    position = position_dodge(width = 0.18),
    color="gray5",
    width = 0.1,
    alpha = 0.8,
    outlier.shape = NA
  ) +
  geom_point(data=biomass_regional_means_plot,
  aes(x=biomass_mean, y = y_pos, color = region),
  fill="gray5",
  shape = 23,
  size = 2.6,
  position = position_dodge(width = 0.18)
)+
  theme_bw()+
  labs(x="Mean per-capita biomass (g)",y="Density",color="Age group",linetype="Age group") +
  scale_color_manual(values=c("darkgoldenrod2","deepskyblue3"))+
  scale_fill_manual(values=c("darkgoldenrod2","gray80","deepskyblue3","gray80"),breaks=c("Caribbean_pre_exp","Caribbean_modern" ,"Pacific_pre_exp","Pacific_modern"),labels=c("Caribbean_pre_exp","Caribbean_modern" ,"Pacific_pre_exp","Pacific_modern"))+
  theme(axis.text = element_text(size=12),axis.title= element_text(size=16))+
  theme(legend.text = element_text(size=12),legend.title = element_text(size=16))+
  theme(axis.text=element_text(color="black",family="sans"),axis.title= element_text(color="black",family="sans",hjust=0.5))+
  theme(panel.grid.major.y = element_blank())+
  scale_x_continuous(trans='log2')+
  theme(legend.position = "none")+
  theme(aspect.ratio=0.7)+
  guides(color="none")+
  facet_grid(~region)+
  theme(strip.background = element_rect(fill = NA, color = NA),
        strip.text = element_text(size = 18))
  
fig3a

```

figure 3B
```{r}

prop_biomass_feeding <- oto_biomass_merged %>% 
  select(basin,age_group,pisc_prop,carn_prop,plank_prop,herb_prop) %>% 
  pivot_longer(cols = c(pisc_prop,carn_prop,plank_prop,herb_prop), names_to = "feeding", values_to = "proportional_biomass") %>% 
  mutate(percent_biomass = proportional_biomass*100) %>% 
group_by(basin,age_group,feeding) %>% 
  #summary statistics
  summarize(biomass_mean=mean(proportional_biomass, na.rm=T), 
            biomass_sd=sd(proportional_biomass, na.rm=T),
            biomass_stderr=std.error(proportional_biomass, na.rm=T)) %>% 
  #create variable for plotting
  unite(age_group_region, c("basin","age_group"),remove=F) %>% 
  mutate(age_group_region=as.factor(age_group_region))
prop_biomass_feeding


#plot Caribbean
carib_prop_biomass <- prop_biomass_feeding %>% 
  filter(basin=="Caribbean") %>% 
ggplot(aes(y=feeding, x=biomass_mean,fill=age_group_region,color=basin))+
  geom_bar(aes(color=basin),stat="identity",position="dodge",linewidth=0.8,alpha=0.8)+
  geom_errorbarh(aes(xmin=biomass_mean-biomass_stderr, xmax=biomass_mean+biomass_stderr), height=.2,
                 position=position_dodge(.9),color="gray30",linetype=1,size=0.6)+
  theme_bw()+
  scale_y_discrete(limits=c("herb_prop","plank_prop","carn_prop","pisc_prop"),labels=c("herbivores","planktivores","generalized\ncarnivores","piscivores"))+
  scale_color_manual(values=c("darkgoldenrod2"))+
  scale_fill_manual(values=c("darkgoldenrod2","gray80"),limits=c("Caribbean_pre_exp","Caribbean_modern"),labels=c("Caribbean_pre_exp","Caribbean_modern"))+
  theme(axis.text = element_text(size=10),axis.title= element_text(size=14))+
  theme(axis.text=element_text(color="black",family="sans"),axis.title= element_text(color="black",family="sans"))+
  theme(axis.title.x = element_text(vjust=-0.4))+
  theme(legend.position="none")+
  labs(y="", x="",fill="Age group") +
  coord_cartesian(xlim = c(.75, 0))+
  theme(aspect.ratio=1.1)
carib_prop_biomass


#plot Pacific
pac_prop_biomass <- prop_biomass_feeding %>% 
  filter(basin=="Pacific") %>%
ggplot(aes(y=feeding, x=biomass_mean,fill=age_group_region,color=basin))+
  geom_bar(aes(color=basin),stat="identity",position="dodge",linewidth=0.8,alpha=0.8)+
  geom_errorbarh(aes(xmin=biomass_mean-biomass_stderr, xmax=biomass_mean+biomass_stderr), height=.2,
                 position=position_dodge(.9),color="gray30",linetype=1,size=0.6)+
  theme_bw()+
  scale_y_discrete(limits=c("herb_prop","plank_prop","carn_prop","pisc_prop"),labels=c("herbivores","planktivores","generalized\ncarnivores","piscivores"))+
  scale_color_manual(values=c("deepskyblue3"))+
  scale_fill_manual(values=c("deepskyblue3","gray80"),limits=c("Pacific_pre_exp","Pacific_modern"),labels=c("Pacific_pre_exp","Pacific_modern"))+
  theme(axis.text = element_text(size=10),axis.title= element_text(size=14))+
  theme(axis.text=element_text(color="black",family="sans"),axis.title= element_text(color="black",family="sans"))+
  theme(axis.title.x = element_text(vjust=-0.4))+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  theme(legend.position="none")+
  labs(y="", x="",fill="Age group") +
  coord_cartesian(xlim = c(0, .75))+
  theme(aspect.ratio=1.1)
pac_prop_biomass
  

##combine
fig3b <- carib_prop_biomass+pac_prop_biomass+
  plot_layout(widths = c(1, 1)) &  
  theme(plot.margin = margin(1, 1, 1, 1))&
  plot_annotation(
    theme = theme(
      plot.caption = element_text(hjust = 0.62,vjust=6, size = 14)),
    caption = "Proportional biomass")

fig3b

```

```{r}
##output fig 3a
ggsave("xmus_oto_fig3a.pdf",plot=fig3a,device="pdf",useDingbats=FALSE)

```

```{r}
##output fig 3b
ggsave("xmus_oto_fig3b.pdf",plot=fig3b,device="pdf",useDingbats=FALSE)

```

### figure S7
mean per-capita fish biomass by site
```{r fig.width=4}

#calculate sample sizes
oto_biomass_merged %>%
  mutate(site_plotting = case_when(
         str_starts(site_name, "Sweet Bocas") ~ "Sweet Bocas",
         str_starts(site_name, "Casa") ~ "Casa Blanca",
         TRUE~site_name)) %>%
  group_by(site_plotting)%>%
  tally()

#overall mean
oto_biomass_merged %>%
  group_by(basin) %>% 
  summarize(overall_mean = mean(per_capita_biomass,na.rm=T))


#plot
oto_biomass_merged %>%
  mutate(region=factor(region, levels = c("Bocas", "Gulf of Panama"),labels=c("Caribbean (Bocas del Toro)","Pacific (Gulf of Panama)"))) %>%
  mutate(site_plotting = case_when(
         str_starts(site_name, "Sweet Bocas") ~ "Sweet Bocas",
         str_starts(site_name, "Casa") ~ "Casa Blanca",
         TRUE~site_name)) %>% 
  mutate(site_plotting=factor(site_plotting, levels = c("Casa Blanca","Cayo Adriana","Crawl Cay","Punta Caracol","Punta Donato","STRI Point","Sunset Point","Sweet Bocas","Contadora","Isla Iguana","Saboga"),labels=c("Casa Blanca (n=15)","Cayo Adriana (n=5)","Crawl Cay (n=1)","Punta Caracol (n=9)","Punta Donato (n=4)","STRI Point (n=7)","Sunset Point (n=8)","Sweet Bocas (n=17)","Contadora (n=12)","Isla Iguana (n=13)","Saboga (n=18)"))) %>% 
  filter(!is.na(site_plotting)) %>% 
ggplot(aes(x=per_capita_biomass,y=site_plotting))+
  geom_vline(xintercept=3.231187	,color="deepskyblue3",linetype=2)+ #overall mean
  geom_vline(xintercept=1.735664,color="darkgoldenrod2",linetype=2)+
  geom_boxplot(aes(color=region,fill=age_group_region),alpha=0.6)+
  theme_bw()+
  labs(x="Mean per-capita biomass (g)",y="Site",color="Region",fill="Group") +
  scale_color_manual(values=c("darkgoldenrod2","deepskyblue3"))+
  scale_fill_manual(values=c("darkgoldenrod2","gray80","deepskyblue3","gray80"),breaks=c("Caribbean_pre_exp","Caribbean_modern" ,"Pacific_pre_exp","Pacific_modern"),labels=c("Caribbean Mid-Holocene","Caribbean Modern" ,"Pacific Mid-Holocene","Pacific Modern"))+
  theme(axis.text = element_text(size=12),axis.title= element_text(size=16))+
  theme(legend.text = element_text(size=12),legend.title = element_text(size=16))+
  theme(axis.text=element_text(color="black",family="sans"),axis.title= element_text(color="black",family="sans",hjust=0.5))+
  scale_x_continuous(trans='log2')+
  theme(legend.position = "right")+
  theme(aspect.ratio=0.75)

```

### figure S10
distributions/boxplot of per capita biomass by trophic group
```{r fig.height=5,fig.width=4}

#calculate means
trophic_biomass_means_plot <- oto_biomass_merged %>%
  pivot_longer(cols = c(pisc_pcb,carn_pcb,plank_pcb,herb_pcb), names_to = "feeding", values_to = "per_cap_biomass") %>%
  mutate(per_cap_biomass = replace_na(per_cap_biomass, 0)) %>% #NAs as 0 to represent absence of that feeding group
  mutate(region=factor(region, levels = c("Bocas", "Gulf of Panama"),labels=c("Caribbean (Bocas del Toro)","Pacific (Gulf of Panama)"))) %>%
  mutate(feeding=factor(feeding, levels = c("pisc_pcb", "carn_pcb","plank_pcb","herb_pcb"),labels=c("piscivores","gen carnivores","planktivores","herbivores"))) %>%
  mutate(feeding_region = paste0(as.character(feeding), "_", as.character(region)),
    facet_label = as.character(feeding)) %>%
  mutate(feeding_region = factor(feeding_region,levels = c("piscivores_Caribbean (Bocas del Toro)", "piscivores_Pacific (Gulf of Panama)","gen carnivores_Caribbean (Bocas del Toro)", "gen carnivores_Pacific (Gulf of Panama)","planktivores_Caribbean (Bocas del Toro)", "planktivores_Pacific (Gulf of Panama)","herbivores_Caribbean (Bocas del Toro)", "herbivores_Pacific (Gulf of Panama)"))) %>%
  group_by(region,age_group,feeding_region) %>% 
  summarize(biomass_mean = mean(per_cap_biomass,na.rm=T)) %>% 
  mutate(y_pos = case_when(
    age_group == "Modern" ~ -0.155,
    age_group == "Mid-Holocene" ~ -0.065
  ))
  
 trophic_biomass_means_plot 
  
  

#calculate sample sizes for labels, non-zero points
sample_sizes <- oto_biomass_merged %>%
  pivot_longer(cols = c(pisc_pcb, carn_pcb, plank_pcb, herb_pcb),
               names_to = "feeding", values_to = "per_cap_biomass") %>%
  mutate(
    region = factor(region, levels = c("Bocas", "Gulf of Panama"),
                    labels = c("Caribbean (Bocas del Toro)", "Pacific (Gulf of Panama)")),
    feeding = factor(feeding,
                     levels = c("pisc_pcb", "carn_pcb", "plank_pcb", "herb_pcb"),
                     labels = c("piscivores", "gen carnivores", "planktivores", "herbivores")),
    feeding_region = paste0(feeding, "_", region)
  ) %>%
  filter(!is.na(per_cap_biomass)) %>%
  group_by(basin,feeding)%>%
  count(feeding_region)  # counts per panel


labels_with_n <- setNames(
  paste0(gsub("_.*", "", sample_sizes$feeding_region), " (n=", sample_sizes$n, ")"),
  sample_sizes$feeding_region
)


#plot
oto_biomass_merged %>%
  pivot_longer(cols = c(pisc_pcb,carn_pcb,plank_pcb,herb_pcb), names_to = "feeding", values_to = "per_cap_biomass") %>%
  mutate(per_cap_biomass = replace_na(per_cap_biomass, 0)) %>% #NAs as 0 to represent absence of that feeding group
  mutate(region=factor(region, levels = c("Bocas", "Gulf of Panama"),labels=c("Caribbean (Bocas del Toro)","Pacific (Gulf of Panama)"))) %>%
  mutate(feeding=factor(feeding, levels = c("pisc_pcb", "carn_pcb","plank_pcb","herb_pcb"),labels=c("piscivores","gen carnivores","planktivores","herbivores"))) %>%
  mutate(feeding_region = paste0(as.character(feeding), "_", as.character(region)),
    facet_label = as.character(feeding)) %>%
  mutate(feeding_region = factor(feeding_region,levels = c("piscivores_Caribbean (Bocas del Toro)", "piscivores_Pacific (Gulf of Panama)","gen carnivores_Caribbean (Bocas del Toro)", "gen carnivores_Pacific (Gulf of Panama)","planktivores_Caribbean (Bocas del Toro)", "planktivores_Pacific (Gulf of Panama)","herbivores_Caribbean (Bocas del Toro)", "herbivores_Pacific (Gulf of Panama)"))) %>% 
ggplot(aes(x=per_cap_biomass))+
  geom_density(position="identity",aes(color=region,fill=age_group_region),alpha=0.6,linewidth=0.8,adjust=2)+
  geom_boxplot(
    aes(y = -0.11, fill = age_group_region,color=region),
    position = position_dodge(width = 0.18),
    color="gray5",
    width = 0.1,
    alpha = 0.8,
    outlier.shape = NA) +
  theme_bw()+
  labs(x="Mean per-capita biomass (g)",y="Density",color="Region",linetype="Region") +
  scale_color_manual(values=c("darkgoldenrod2","deepskyblue3"))+
  scale_fill_manual(values=c("darkgoldenrod2","gray80","deepskyblue3","gray80"),breaks=c("Caribbean_pre_exp","Caribbean_modern" ,"Pacific_pre_exp","Pacific_modern"),labels=c("Caribbean_pre_exp","Caribbean_modern" ,"Pacific_pre_exp","Pacific_modern"))+
  theme(axis.text = element_text(size=12),axis.title= element_text(size=16))+
  theme(legend.text = element_text(size=12),legend.title = element_text(size=16))+
  theme(axis.text=element_text(color="black",family="sans"),axis.title= element_text(color="black",family="sans",hjust=0.5))+
  theme(panel.grid.major.y = element_blank())+
  scale_x_continuous(trans='log2')+
  theme(legend.position = "bottom")+
  theme(aspect.ratio=0.7)+
  guides(fill="none")+
  facet_wrap(~ feeding_region, scales = "free", ncol = 2,
             labeller = labeller(feeding_region = labels_with_n)) +
  theme(strip.background = element_rect(fill = NA, color = NA),
        strip.text = element_text(size = 16))
  
  
```


## Quantifying differences

overall
```{r}

biomass_summ <- oto_biomass_merged %>%
  group_by(basin,region,age_group) %>%
  summarize(n = sum(!is.na(per_capita_biomass)),
            mean_pcb = mean(per_capita_biomass,na.rm=T),
            median_pcb = median(per_capita_biomass,na.rm=T),
            sd_pcb = sd(per_capita_biomass,na.rm=T),
            skew_pcb = skew(per_capita_biomass,na.rm=T),
            kurtosis_pcb = kurtosi(per_capita_biomass,na.rm=T))

biomass_summ



#cross-isthmus, mid-holocene
biomass_summ$mean_pcb[4]/biomass_summ$mean_pcb[2]

#cross-isthmus, modern
biomass_summ$mean_pcb[3]/biomass_summ$mean_pcb[1]

#%change
((biomass_summ$mean_pcb[3]-biomass_summ$mean_pcb[4])/biomass_summ$mean_pcb[3])*100 #pacific
((biomass_summ$mean_pcb[2]-biomass_summ$mean_pcb[1])/biomass_summ$mean_pcb[2])*100 #carib


#%diff
perc_diff(biomass_summ$mean_pcb[4],biomass_summ$mean_pcb[2]) #fossil
perc_diff(biomass_summ$mean_pcb[3],biomass_summ$mean_pcb[1]) #modern


```
### table S4
characteristics for each distribution
```{r fig.width=4}

biomass_summ_S4 <- biomass_summ %>% 
  mutate(age_group=factor(age_group, levels = c("pre_exp", "modern"),labels=c("mid-Holocene","modern"))) %>%
  mutate(region= case_when(
    basin=='Caribbean' ~ "Bocas del Toro",
    basin=='Pacific' ~ "Gulf of Panama"
  )) %>% 
  rename(`Basin`=basin,
         `Region`=region,
         `Time period`=age_group,
         `N`=n,
         `Mean`=mean_pcb,
         `Median`=median_pcb,
         `Std dev`=sd_pcb,
         `Skew`=skew_pcb,
         `Kurtosis`=kurtosis_pcb)

kable(biomass_summ_S4, digits = 2) %>% 
  kable_classic(full_width = FALSE) %>% 
  kable_styling(font_size=14) %>%
  row_spec(0, bold = TRUE)

```

by feeding group, NAs=0s (related to figure 2B)
```{r}

biomass_summ_fam <- oto_biomass_merged %>%
  pivot_longer(cols = c(pisc_pcb,carn_pcb,plank_pcb,herb_pcb), names_to = "feeding", values_to = "per_cap_biomass") %>%
  mutate(per_cap_biomass = replace_na(per_cap_biomass, 0)) %>% #NAs as 0 to represent absence of feeding group
  group_by(basin,age_group,feeding) %>%
  summarize(mean_pcb = mean(per_cap_biomass,na.rm=T),
            median_pcb = median(per_cap_biomass,na.rm=T),
            non_na_count = sum(!is.na(per_cap_biomass)))
biomass_summ_fam

#across basins, during mid-Holocene
biomass_summ_fam %>% 
  select(basin, age_group,feeding,mean_pcb) %>%
  filter(age_group=="pre_exp") %>% 
  pivot_wider(names_from = basin, values_from = mean_pcb) %>%
  mutate(mag = Pacific/Caribbean,
         mag_Carib = Caribbean/Pacific)


#%change over time in each region, by feeding group
biomass_summ_fam %>% 
  select(basin, age_group,feeding,mean_pcb) %>% 
  pivot_wider(names_from = age_group, values_from = mean_pcb) %>% 
  mutate(perc_change = (abs(pre_exp-modern)/pre_exp)*100)

```

testing for differences in distributions, K-S test
```{r}

#across isthmus
ks.test(oto_biomass_merged$per_capita_biomass[oto_biomass_merged$basin=="Caribbean" & oto_biomass_merged$age_group=="pre_exp"],oto_biomass_merged$per_capita_biomass[oto_biomass_merged$basin=="Pacific" & oto_biomass_merged$age_group=="pre_exp"])

ks.test(oto_biomass_merged$per_capita_biomass[oto_biomass_merged$basin=="Caribbean" & oto_biomass_merged$age_group=="modern"],oto_biomass_merged$per_capita_biomass[oto_biomass_merged$basin=="Pacific" & oto_biomass_merged$age_group=="modern"])


#over time
ks.test(oto_biomass_merged$per_capita_biomass[oto_biomass_merged$basin=="Caribbean" & oto_biomass_merged$age_group=="pre_exp"],oto_biomass_merged$per_capita_biomass[oto_biomass_merged$basin=="Caribbean" & oto_biomass_merged$age_group=="modern"])

ks.test(oto_biomass_merged$per_capita_biomass[oto_biomass_merged$basin=="Pacific" & oto_biomass_merged$age_group=="pre_exp"],oto_biomass_merged$per_capita_biomass[oto_biomass_merged$basin=="Pacific" & oto_biomass_merged$age_group=="modern"])

```

fish length
```{r}

length_summ <- oto_biomass_merged_pre %>%
  group_by(basin,age_group) %>%
  summarize(mean_tl = mean(fish_length_cm,na.rm=T),
            median_tl = median(fish_length_cm,na.rm=T))

length_summ


#cross-isthmus, mid-holocene
length_summ$mean_tl[4]/length_summ$mean_tl[2]

#cross-isthmus, modern
length_summ$mean_tl[3]/length_summ$mean_tl[1]

#%change
((length_summ$mean_tl[3]-length_summ$mean_tl[4])/length_summ$mean_tl[3])*100#pacific
((length_summ$mean_tl[2]-length_summ$mean_tl[1])/length_summ$mean_tl[2])*100 #carib


#testing for differences in distributions of fish length

ks.test(oto_biomass_merged_pre$fish_length_cm[oto_biomass_merged_pre$basin=="Caribbean" & oto_biomass_merged_pre$age_group=="pre_exp"],oto_biomass_merged_pre$fish_length_cm[oto_biomass_merged_pre$basin=="Caribbean" & oto_biomass_merged_pre$age_group=="modern"])


ks.test(oto_biomass_merged_pre$fish_length_cm[oto_biomass_merged_pre$basin=="Pacific" & oto_biomass_merged_pre$age_group=="pre_exp"],oto_biomass_merged_pre$fish_length_cm[oto_biomass_merged_pre$basin=="Pacific" & oto_biomass_merged_pre$age_group=="modern"])

```